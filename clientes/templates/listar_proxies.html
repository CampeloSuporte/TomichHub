{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="main-content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Servidores Proxy</h4>
            <button class="btn btn-primary" onclick="abrirModalCadastrarProxy()">
                <i class="fas fa-plus me-2"></i> Adicionar Proxy
            </button>
        </div>

        <!-- Cards de Proxies -->
        <div class="row">
            {% if proxies %}
                {% for proxy in proxies %}
                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="server-header flex-column align-items-start">
                                <div class="d-flex align-items-center justify-content-between w-100 mb-3">
                                    <h5 class="mb-0">{{ proxy.nome }}</h5>
                                    <div class="status-badge {% if proxy.ativo %}status-online{% else %}status-offline{% endif %}">
                                        {% if proxy.ativo %}
                                            <i class="fas fa-circle me-1"></i> Ativo
                                        {% else %}
                                            <i class="fas fa-circle me-1"></i> Inativo
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="icon-btn btn-sm" onclick="testarProxy({{ proxy.id }})" title="Testar Conexão">
                                        <i class="fas fa-plug"></i>
                                    </button>
                                    <button class="icon-btn btn-sm" onclick="toggleProxyStatus({{ proxy.id }})" title="{% if proxy.ativo %}Desativar{% else %}Ativar{% endif %}">
                                        <i class="fas fa-power-off"></i>
                                    </button>
                                    <button class="icon-btn btn-sm" onclick="abrirModalEditarProxy({{ proxy.id }})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <form method="POST" action="{% url 'deletar_proxy' proxy.id %}" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('Tem certeza que deseja excluir o proxy: {{ proxy.nome }}?')">
                                        {% csrf_token %}
                                        <button type="submit" class="icon-btn btn-sm" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="info-row">
                                <span class="info-label">Host</span>
                                <span class="info-value copyable" onclick="copiarTexto('{{ proxy.host }}')">{{ proxy.host }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Porta</span>
                                <span class="info-value">{{ proxy.porta }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Usuário</span>
                                <span class="info-value copyable" onclick="copiarTexto('{{ proxy.usuario }}')">{{ proxy.usuario }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Senha</span>
                                <span class="info-value copyable" onclick="copiarTexto('{{ proxy.senha }}')">{{ proxy.senha }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Cadastrado em</span>
                                <span class="info-value">{{ proxy.data_criacao|date:"d/m/Y H:i" }}</span>
                            </div>

                            <div class="mt-4">
                                <button class="btn btn-access mb-2" onclick="testarProxy({{ proxy.id }})">
                                    <i class="fas fa-plug me-2"></i> Testar Conexão
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12 text-center mt-4">
                    <i class="fas fa-server" style="font-size: 64px; color: var(--primary-green); opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Nenhum servidor proxy cadastrado</p>
                    <button class="btn btn-primary mt-3" onclick="abrirModalCadastrarProxy()">
                        <i class="fas fa-plus me-2"></i> Adicionar Primeiro Proxy
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Cadastrar Proxy -->
<div id="modalCadastrarProxy" class="modal-overlay" style="display: none;">
    <div class="modal-acesso">
        <div class="modal-header-acesso">
            <h2 class="modal-title"><span class="terminal-prefix">&gt;</span> Cadastrar Servidor Proxy</h2>
            <button class="btn-close-modal" onclick="fecharModalCadastrarProxy()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body-acesso">
            <form id="formCadastrarProxy" method="POST" action="{% url 'cadastrar_proxy' %}">
                {% csrf_token %}
                
                <div class="form-group-modal">
                    <label><span class="label-prefix">&gt;</span> Nome do Proxy</label>
                    <input type="text" name="nome" class="form-control" placeholder="Ex: Proxy Datacenter 1" required>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Host/IP</label>
                            <input type="text" name="host" class="form-control" placeholder="Ex: 192.168.1.1" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Porta</label>
                            <input type="number" name="porta" class="form-control" value="22" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Usuário</label>
                            <input type="text" name="usuario" class="form-control" placeholder="root" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Senha</label>
                            <input type="password" name="senha" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="form-group-modal">
                    <div class="form-check">
                        <input type="checkbox" name="ativo" class="form-check-input" id="ativo" checked>
                        <label class="form-check-label" for="ativo">
                            Ativar proxy imediatamente
                        </label>
                    </div>
                </div>

                <div class="terminal-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Servidor proxy para acesso a redes privadas</span>
                </div>

                <div class="modal-footer-acesso">
                    <button type="button" class="btn-cancel-modal" onclick="fecharModalCadastrarProxy()">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </button>
                    <button type="submit" class="btn-submit-modal">
                        <i class="fas fa-save me-2"></i> Cadastrar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Proxy -->
<div id="modalEditarProxy" class="modal-overlay" style="display: none;">
    <div class="modal-acesso">
        <div class="modal-header-acesso">
            <h2 class="modal-title"><span class="terminal-prefix">&gt;</span> Editar Servidor Proxy</h2>
            <button class="btn-close-modal" onclick="fecharModalEditarProxy()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body-acesso">
            <form id="formEditarProxy" method="POST" action="">
                {% csrf_token %}
                
                <input type="hidden" id="edit_proxy_id" name="id">
                
                <div class="form-group-modal">
                    <label><span class="label-prefix">&gt;</span> Nome do Proxy</label>
                    <input type="text" id="edit_nome" name="nome" class="form-control" required>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Host/IP</label>
                            <input type="text" id="edit_host" name="host" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Porta</label>
                            <input type="number" id="edit_porta" name="porta" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Usuário</label>
                            <input type="text" id="edit_usuario" name="usuario" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group-modal">
                            <label><span class="label-prefix">&gt;</span> Senha</label>
                            <input type="password" id="edit_senha" name="senha" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="form-group-modal">
                    <div class="form-check">
                        <input type="checkbox" name="ativo" class="form-check-input" id="edit_ativo">
                        <label class="form-check-label" for="edit_ativo">
                            Proxy ativo
                        </label>
                    </div>
                </div>

                <div class="modal-footer-acesso">
                    <button type="button" class="btn-cancel-modal" onclick="fecharModalEditarProxy()">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </button>
                    <button type="submit" class="btn-submit-modal">
                        <i class="fas fa-save me-2"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Funções Modais
function abrirModalCadastrarProxy() {
    document.getElementById('modalCadastrarProxy').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function fecharModalCadastrarProxy() {
    document.getElementById('modalCadastrarProxy').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('formCadastrarProxy').reset();
}

function abrirModalEditarProxy(proxyId) {
    fetch(`/clientes/proxies/buscar/${proxyId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_proxy_id').value = data.id;
            document.getElementById('edit_nome').value = data.nome;
            document.getElementById('edit_host').value = data.host;
            document.getElementById('edit_porta').value = data.porta;
            document.getElementById('edit_usuario').value = data.usuario;
            document.getElementById('edit_senha').value = data.senha;
            document.getElementById('edit_ativo').checked = data.ativo;
            
            document.getElementById('formEditarProxy').action = `/clientes/proxies/editar/${proxyId}/`;
            document.getElementById('modalEditarProxy').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('ERRO', 'Não foi possível carregar os dados do proxy.', 5000);
        });
}

function fecharModalEditarProxy() {
    document.getElementById('modalEditarProxy').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Testar Conexão do Proxy
function testarProxy(proxyId) {
    // Mostrar loading
    showInfo('TESTANDO', 'Testando conexão com o proxy...', 3000);
    
    fetch(`/clientes/proxies/testar/${proxyId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('CONEXÃO OK', data.message, 5000);
            } else {
                showError('ERRO', data.message, 5000);
            }
        })
        .catch(error => {
            showError('ERRO', 'Erro ao testar conexão com o proxy.', 5000);
        });
}

// Toggle Status do Proxy
function toggleProxyStatus(proxyId) {
    fetch(`/clientes/proxies/toggle/${proxyId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('STATUS ATUALIZADO', data.message, 3000);
                // Recarregar página após 1 segundo
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showError('ERRO', data.error, 5000);
            }
        })
        .catch(error => {
            showError('ERRO', 'Erro ao alterar status do proxy.', 5000);
        });
}

// Copiar texto
function copiarTexto(texto) {
    navigator.clipboard.writeText(texto).then(() => {
        showSuccess('COPIADO', 'Texto copiado para a área de transferência!', 2000);
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = texto;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('COPIADO', 'Texto copiado para a área de transferência!', 2000);
    });
}

// Fechar modais ao clicar fora
document.addEventListener('click', function(e) {
    const modalCadastrar = document.getElementById('modalCadastrarProxy');
    if (e.target === modalCadastrar) {
        fecharModalCadastrarProxy();
    }
    
    const modalEditar = document.getElementById('modalEditarProxy');
    if (e.target === modalEditar) {
        fecharModalEditarProxy();
    }
});

// ESC fecha modais
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fecharModalCadastrarProxy();
        fecharModalEditarProxy();
    }
});
</script>

<style>
.status-badge {
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 11px;
    font-family: 'Courier New', monospace;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
}

.status-online {
    background: rgba(0, 255, 136, 0.15);
    color: var(--primary-green);
    border: 1px solid var(--primary-green);
}

.status-online i {
    font-size: 8px;
    animation: pulse-dot 2s ease-in-out infinite;
}

.status-offline {
    background: rgba(139, 148, 158, 0.15);
    color: var(--text-muted);
    border: 1px solid var(--text-muted);
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
</style>

{% if messages %}
<script>
    {% for message in messages %}
        setTimeout(function() {
            {% if message.tags == 'success' %}
                showSuccess('OPERAÇÃO CONCLUÍDA', '{{ message|escapejs }}', 5000);
            {% elif message.tags == 'error' %}
                showError('ERRO', '{{ message|escapejs }}', 6000);
            {% elif message.tags == 'warning' %}
                showWarning('ATENÇÃO', '{{ message|escapejs }}', 6000);
            {% elif message.tags == 'info' %}
                showInfo('INFORMAÇÃO', '{{ message|escapejs }}', 5000);
            {% else %}
                showInfo('NOTIFICAÇÃO', '{{ message|escapejs }}', 5000);
            {% endif %}
        }, 300);
    {% endfor %}
</script>
{% endif %}

{% endblock content %}