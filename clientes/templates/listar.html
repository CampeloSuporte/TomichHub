{% extends "base.html" %}
{% load static %}
{% block content %}
<!-- Main Content -->
<div class="main-content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">{{ cliente.nome_empresa}} CNPJ:{{ cliente.cnpj}}</h4>
            <button class="btn btn-outline-primary btn-sm">Editar</button>
        </div>

        <!-- Main Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="trocarAba(event, 'acessos')">Acessos</a>
            </li>
            <!--
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'extrato')">Extrato</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'backups')">Backups</a>
            </li>
            -->
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'vpn')">VPN</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'topologia')">Topologia</a>
            </li>
            <!--
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'tuneis')">Tuneis SSH</a>
            </li>
            -->
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'documentos')">Documentos</a>
            </li>
            <!--
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'credenciais')">Credenciais</a>
            </li>
            -->
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="trocarAba(event, 'chamados')">Chamados</a>
            </li>
        </ul>

        <!-- ABA ACESSOS -->
        <div id="tab-acessos" class="tab-content-main" style="display: block;">
            <div class="d-flex justify-content-end gap-2 mb-3">
                <button class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-filter me-1"></i> Filtrar Acessos
                </button>
                <button class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-cog me-1"></i> Configuração
                </button>
                <button class="btn btn-sm btn-primary" onclick="abrirModalAcesso()">
                    <i class="fas fa-plus me-1"></i> Adicionar
                </button>
            </div>

            {% regroup acessos by funcao as acessos_por_funcao %}

            <ul class="nav server-tabs mb-4" id="funcaoTabs">
                {% for grupo in acessos_por_funcao %}
                <li class="nav-item">
                    <a class="nav-link {% if forloop.first %}active{% endif %}" href="#" 
                       onclick="mostrarFuncao(event, '{{ grupo.grouper }}')">
                        {{ grupo.grouper }}
                    </a>
                </li>
                {% endfor %}
            </ul>

            {% for grupo in acessos_por_funcao %}
            <div class="funcao-content" id="funcao-{{ grupo.grouper }}" 
                 style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="row">
                    {% for acesso in grupo.list %}
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="server-header flex-column align-items-start">
                                    <div class="d-flex align-items-center justify-content-between w-100 mb-3">
                                        <h5 class="mb-0">{{ acesso.tipo }}</h5>
                                    </div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <form method="POST" action="{% url 'deletar_acesso' acesso.id %}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Tem certeza que deseja excluir: {{ acesso.tipo }}?')">
                                            {% csrf_token %}
                                            <button type="submit" class="icon-btn btn-sm" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                        <button class="icon-btn btn-sm"><i class="fas fa-link"></i></button>
                                        <button class="icon-btn btn-sm"><i class="fas fa-code"></i></button>
                                        <button class="icon-btn btn-sm"><i class="fas fa-file"></i></button>
                                        <button class="icon-btn btn-sm" onclick="abrirModalEditarAcesso({{ acesso.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><a class="nav-link active" href="#">Padrão</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-plus"></i></a></li>
                                </ul>
                                <div class="info-row">
                                    <span class="info-label">Modelo</span>
                                    <span class="info-value">{{ acesso.modelo }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Vlan Gerencia</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.vlan }}')">{{ acesso.vlan }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Host Name</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.host }}')">{{ acesso.host }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">HostName v6</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.host_ipv6 }}')">{{ acesso.host_ipv6 }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Porta</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.porta }}')">{{ acesso.porta }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Protocolo</span>
                                    <span class="info-value">{{ acesso.protocolo }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Usuário</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.usuario }}')">{{ acesso.usuario }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Senha</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.senha }}')">{{ acesso.senha }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Senha Root</span>
                                    <span class="info-value copyable" onclick="copiarTexto('{{ acesso.senha_adm }}')">{{ acesso.senha_adm }}</span>
                                </div>
                                <div class="mt-4">
                                    <button class="btn btn-access mb-2">
                                        <i class="fas fa-sign-in-alt me-2"></i> Acessar
                                    </button>
                                    <button class="btn btn-backup">
                                        <i class="fas fa-sync-alt me-2"></i> Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center mt-4">
                <div class="alert alert-warning">Nenhum acesso cadastrado.</div>
            </div>
            {% endfor %}
        </div>

        <!-- OUTRAS ABAS -->
         
        <div id="tab-extrato" class="tab-content-main" style="display: none;">
            <div class="card"><div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Extrato de Movimentações</h5>
                    <button class="btn btn-sm btn-primary"><i class="fas fa-download me-1"></i> Exportar</button>
                </div>
                <div class="text-center py-5">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 64px; color: var(--primary-green); opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Conteúdo do extrato será exibido aqui</p>
                </div>
            </div></div>
        </div>

        <div id="tab-backups" class="tab-content-main" style="display: none;">
            <div class="card"><div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Gerenciamento de Backups</h5>
                    <button class="btn btn-sm btn-primary"><i class="fas fa-plus me-1"></i> Novo Backup</button>
                </div>
                <div class="text-center py-5">
                    <i class="fas fa-database" style="font-size: 64px; color: var(--accent-cyan); opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Lista de backups será exibida aqui</p>
                </div>
            </div></div>
        </div>
        <!-- ABA VPN -->
        <div id="tab-vpn" class="tab-content-main" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Configurações VPN</h5>
                        <button class="btn btn-sm btn-primary" onclick="abrirModalUploadVPN()">
                            <i class="fas fa-upload me-1"></i> Adicionar VPN
                        </button>
                    </div>
                    
                    {% if arquivos_vpn %}
                    <div class="row">
                        {% for vpn in arquivos_vpn %}
                        <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="server-header flex-column align-items-start">
                                        <div class="d-flex align-items-center justify-content-between w-100 mb-3">
                                            <h5 class="mb-0">{{ vpn.nome }}</h5>
                                        </div>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <a href="{{ vpn.arquivo.url }}" target="_blank" class="icon-btn btn-sm" title="Visualizar">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ vpn.arquivo.url }}" download class="icon-btn btn-sm" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button class="icon-btn btn-sm" onclick="abrirModalEditarVPN({{ vpn.id }})" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" action="{% url 'deletar_vpn' vpn.id %}" 
                                                style="display: inline;" 
                                                onsubmit="return confirm('Tem certeza que deseja excluir: {{ vpn.nome }}?')">
                                                {% csrf_token %}
                                                <button type="submit" class="icon-btn btn-sm" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <div class="info-row">
                                        <span class="info-label">Arquivo</span>
                                        <span class="info-value">{{ vpn.arquivo.size|filesizeformat }}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Data Upload</span>
                                        <span class="info-value">{{ vpn.data_upload|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    {% if vpn.usuario %}
                                    <div class="info-row">
                                        <span class="info-label">Usuário</span>
                                        <span class="info-value copyable" onclick="copiarTexto('{{ vpn.usuario }}')">{{ vpn.usuario }}</span>
                                    </div>
                                    {% endif %}
                                    {% if vpn.senha %}
                                    <div class="info-row">
                                        <span class="info-label">Senha</span>
                                        <span class="info-value copyable" onclick="copiarTexto('{{ vpn.senha }}')">{{ vpn.senha }}</span>
                                    </div>
                                    {% endif %}
                                    {% if vpn.private_key %}
                                    <div class="info-row">
                                        <span class="info-label">Private Key</span>
                                        <span class="info-value">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="visualizarPrivateKey('{{ vpn.private_key|escapejs }}', '{{ vpn.nome|escapejs }}')">
                                                <i class="fas fa-key me-1"></i> Ver Chave
                                            </button>
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-4">
                                        <a href="{{ vpn.arquivo.url }}" download class="btn btn-access mb-2">
                                            <i class="fas fa-download me-2"></i> Download Config
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-shield-alt" style="font-size: 64px; color: var(--primary-green); opacity: 0.3;"></i>
                        <p class="mt-3 text-muted">Nenhuma configuração VPN encontrada</p>
                        <button class="btn btn-primary mt-3" onclick="abrirModalUploadVPN()">
                            <i class="fas fa-upload me-2"></i> Adicionar Primeira VPN
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ABA TOPOLOGIA -->
        <div id="tab-topologia" class="tab-content-main" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Topologia de Rede</h5>
                        <button class="btn btn-sm btn-primary" onclick="abrirModalUploadTopologia()">
                            <i class="fas fa-upload me-1"></i> Upload Imagem
                        </button>
                    </div>
                    
                    {% if imagens_topologia %}
                    <div class="row">
                        {% for topologia in imagens_topologia %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body p-0">
                                    <div class="topologia-image-container">
                                        <img src="{{ topologia.imagem.url }}" 
                                            alt="{{ topologia.nome }}" 
                                            class="topologia-image"
                                            onclick="visualizarImagemGrande('{{ topologia.imagem.url }}', '{{ topologia.nome }}')">
                                        <div class="topologia-overlay">
                                            <button class="btn-action-overlay" 
                                                    onclick="visualizarImagemGrande('{{ topologia.imagem.url }}', '{{ topologia.nome }}')" 
                                                    title="Visualizar">
                                                <i class="fas fa-search-plus"></i>
                                            </button>
                                            <a href="{{ topologia.imagem.url }}" 
                                            download 
                                            class="btn-action-overlay" 
                                            title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <form method="POST" 
                                                action="{% url 'deletar_topologia' topologia.id %}" 
                                                style="display: inline;" 
                                                onsubmit="return confirm('Tem certeza que deseja excluir: {{ topologia.nome }}?')">
                                                {% csrf_token %}
                                                <button type="submit" 
                                                        class="btn-action-overlay btn-delete-overlay" 
                                                        title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="p-3">
                                        <p class="mb-1" style="color: var(--primary-green); font-family: 'Courier New', monospace; font-size: 13px; font-weight: 700;">
                                            {{ topologia.nome }}
                                        </p>
                                        <p class="mb-0" style="color: var(--text-muted); font-family: 'Courier New', monospace; font-size: 11px;">
                                            {{ topologia.data_upload|date:"d/m/Y H:i" }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-project-diagram" style="font-size: 64px; color: var(--accent-cyan); opacity: 0.3;"></i>
                        <p class="mt-3 text-muted">Nenhuma topologia encontrada</p>
                        <button class="btn btn-primary mt-3" onclick="abrirModalUploadTopologia()">
                            <i class="fas fa-upload me-2"></i> Enviar Primeira Topologia
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- MODAL VISUALIZAR IMAGEM GRANDE -->
        <div id="modalVisualizarImagem" class="modal-overlay" style="display: none;" onclick="fecharModalImagem()">
            <div class="modal-imagem-grande">
                <button class="btn-close-modal-imagem" onclick="fecharModalImagem()">
                    <i class="fas fa-times"></i>
                </button>
                <img id="imagemGrande" src="" alt="" class="imagem-visualizacao">
                <p id="nomeImagemGrande" class="nome-imagem-visualizacao"></p>
            </div>
        </div>

        <!-- MODAL VISUALIZAR PRIVATE KEY -->
        <div id="modalPrivateKey" class="modal-overlay" style="display: none;">
            <div class="modal-acesso" style="max-width: 700px;">
                <div class="modal-header-acesso">
                    <h2 class="modal-title"><span class="terminal-prefix">&gt;</span> Private Key - <span id="nomeVPNKey"></span></h2>
                    <button class="btn-close-modal" onclick="fecharModalPrivateKey()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body-acesso">
                    <div class="private-key-container">
                        <pre id="privateKeyContent" class="private-key-content"></pre>
                    </div>
                    <div class="terminal-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Chave privada criptografada</span>
                    </div>
                    <div class="modal-footer-acesso">
                        <button type="button" class="btn-cancel-modal" onclick="fecharModalPrivateKey()">
                            <i class="fas fa-times me-2"></i> Fechar
                        </button>
                        <button type="button" class="btn-submit-modal" onclick="copiarPrivateKey()">
                            <i class="fas fa-copy me-2"></i> Copiar Chave
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-tuneis" class="tab-content-main" style="display: none;">
            <div class="card"><div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Tuneis SSH</h5>
                    <button class="btn btn-sm btn-primary"><i class="fas fa-plus me-1"></i> Novo Tunel</button>
                </div>
                <div class="text-center py-5">
                    <i class="fas fa-network-wired" style="font-size: 64px; color: var(--primary-green); opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Tuneis SSH serão listados aqui</p>
                </div>
            </div></div>
        </div>

        <!-- ABA DOCUMENTOS -->
        <div id="tab-documentos" class="tab-content-main" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">Documentos</h5>
                        <button class="btn btn-sm btn-primary" onclick="abrirModalUpload()">
                            <i class="fas fa-upload me-1"></i> Upload
                        </button>
                    </div>
                    
                    {% if documentos %}
                    <div class="table-responsive">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Nome do Arquivo</th>
                                    <th>Data Upload</th>
                                    <th>Tamanho</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documentos %}
                                <tr>
                                    <td>{{ doc.nome }}</td>
                                    <td>{{ doc.data_upload|date:"d/m/Y H:i" }}</td>
                                    <td>{{ doc.arquivo.size|filesizeformat }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ doc.arquivo.url }}" target="_blank" class="btn-action btn-view" title="Visualizar">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ doc.arquivo.url }}" download class="btn-action btn-download" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <form method="POST" action="{% url 'deletar_documento' doc.id %}" 
                                                  style="display: inline;" 
                                                  onsubmit="return confirm('Tem certeza que deseja excluir: {{ doc.nome }}?')">
                                                {% csrf_token %}
                                                <button type="submit" class="btn-action btn-delete" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-folder-open" style="font-size: 64px; color: var(--accent-cyan); opacity: 0.3;"></i>
                        <p class="mt-3 text-muted">Nenhum documento encontrado</p>
                        <button class="btn btn-primary mt-3" onclick="abrirModalUpload()">
                            <i class="fas fa-upload me-2"></i> Enviar Primeiro Documento
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="tab-credenciais" class="tab-content-main" style="display: none;">
            <div class="card"><div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Credenciais</h5>
                    <button class="btn btn-sm btn-primary"><i class="fas fa-plus me-1"></i> Adicionar</button>
                </div>
                <div class="text-center py-5">
                    <i class="fas fa-key" style="font-size: 64px; color: var(--primary-green); opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Credenciais serão exibidas aqui</p>
                </div>
            </div></div>
        </div>

                 
                 <!-- TAB CHAMADOS -->
            <div id="tab-chamados" class="tab-content-main" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">Chamados do Cliente</h5>
                            <button class="btn btn-sm btn-primary" onclick="abrirModalCadastrarChamado()">
                                <i class="fas fa-plus me-1"></i> Novo Chamado
                            </button>
                        </div>
                        
                        <div id="listaChamados">
                            <!-- Os chamados serão carregados aqui via JavaScript -->
                            <div class="text-center py-5">
                                <i class="fas fa-ticket-alt" style="font-size: 64px; color: var(--accent-cyan); opacity: 0.3;"></i>
                                <p class="mt-3 text-muted">Carregando chamados...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    </div>
</div>

{% include 'modal_acessos.html'%}
<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/listar_acesso.js' %}"></script>
<script>
function trocarAba(event, nomeAba) {
    event.preventDefault();
    document.querySelectorAll('.tab-content-main').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('#mainTabs .nav-link').forEach(link => link.classList.remove('active'));
    document.getElementById('tab-' + nomeAba).style.display = 'block';
    event.target.classList.add('active');
}

function abrirModalEditarAcesso(acessoId) {
    fetch(`/clientes/acessos/buscar/${acessoId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_acesso_id').value = data.id;
            document.getElementById('edit_tipo').value = data.tipo;
            document.getElementById('edit_hostname').value = data.host;
            document.getElementById('edit_hostname_ipv6').value = data.host_ipv6 || '';
            document.getElementById('edit_protocolo').value = data.protocolo;
            document.getElementById('edit_porta').value = data.porta;
            document.getElementById('edit_usuario').value = data.usuario;
            document.getElementById('edit_senha').value = data.senha;
            document.getElementById('edit_senha_adm').value = data.senha_adm || '';
            document.getElementById('edit_vlan').value = data.vlan || '';
            document.getElementById('edit_funcao').value = data.funcao_id;
            document.getElementById('edit_funcao_input').value = data.funcao_nome;
            document.getElementById('edit_modelo').value = data.modelo_id;
            document.getElementById('edit_modelo_input').value = data.modelo_nome;
            document.getElementById('formEditarAcesso').action = `/clientes/acessos/editar/${acessoId}/`;
            document.getElementById('modalEditarAcesso').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('ERRO', 'Não foi possível carregar os dados do acesso.', 5000);
        });
}

function fecharModalEditarAcesso() {
    document.getElementById('modalEditarAcesso').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function filterOptions(fieldName) {
    const input = document.getElementById(`${fieldName}_input`);
    const dropdown = document.getElementById(`${fieldName}-dropdown`);
    const hiddenInput = document.getElementById(fieldName);
    const filter = input.value.toUpperCase();
    const options = dropdown.getElementsByClassName('search-select-option');
    let hasVisibleOption = false;
    
    for (let i = 0; i < options.length; i++) {
        const txtValue = options[i].textContent || options[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            options[i].classList.add('visible');
            hasVisibleOption = true;
        } else {
            options[i].classList.remove('visible');
        }
    }
    
    if (hasVisibleOption && input.value !== '') {
        dropdown.classList.add('show');
    } else {
        dropdown.classList.remove('show');
    }
    
    for (let i = 0; i < options.length; i++) {
        options[i].onclick = function() {
            input.value = this.getAttribute('data-text');
            hiddenInput.value = this.getAttribute('data-value');
            dropdown.classList.remove('show');
        };
    }
}

// ============================================
// FUNÇÕES DO MODAL DE UPLOAD
// ============================================

function abrirModalUpload() {
    document.getElementById('modalUploadDocumento').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function fecharModalUpload() {
    document.getElementById('modalUploadDocumento').style.display = 'none';
    document.body.style.overflow = 'auto';
    limparFormularioUpload();
}

function limparFormularioUpload() {
    document.getElementById('formUploadDocumento').reset();
    document.getElementById('uploadArea').style.display = 'flex';
    document.getElementById('filePreview').style.display = 'none';
}

function mostrarPreviewArquivo(file) {
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('filePreview').style.display = 'block';
    
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatarTamanho(file.size);
    
    // Atualizar ícone baseado no tipo
    const fileIcon = document.querySelector('.file-icon');
    const extension = file.name.split('.').pop().toLowerCase();
    
    if (['pdf'].includes(extension)) {
        fileIcon.className = 'fas fa-file-pdf file-icon';
    } else if (['doc', 'docx'].includes(extension)) {
        fileIcon.className = 'fas fa-file-word file-icon';
    } else if (['xls', 'xlsx'].includes(extension)) {
        fileIcon.className = 'fas fa-file-excel file-icon';
    } else if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
        fileIcon.className = 'fas fa-file-image file-icon';
    } else if (['zip', 'rar', '7z'].includes(extension)) {
        fileIcon.className = 'fas fa-file-archive file-icon';
    } else {
        fileIcon.className = 'fas fa-file file-icon';
    }
}

function removerArquivo() {
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadArea').style.display = 'flex';
    document.getElementById('filePreview').style.display = 'none';
}

function formatarTamanho(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ============================================
// EVENT LISTENERS
// ============================================

document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('.search-select-dropdown');
    const inputs = document.querySelectorAll('.search-select-input');
    let clickedInside = false;
    
    inputs.forEach(input => {
        if (input.contains(event.target)) clickedInside = true;
    });
    
    dropdowns.forEach(dropdown => {
        if (dropdown.contains(event.target)) clickedInside = true;
    });
    
    if (!clickedInside) {
        dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
    }
    
    // Fechar modais ao clicar fora
    const modalUpload = document.getElementById('modalUploadDocumento');
    if (event.target === modalUpload) {
        fecharModalUpload();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Upload Area - Click e Drag & Drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                mostrarPreviewArquivo(files[0]);
            }
        });

        // Change do input
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                mostrarPreviewArquivo(e.target.files[0]);
            }
        });
    }
    
    // Mensagens do Django
    {% if messages %}
        {% for message in messages %}
            setTimeout(function() {
                {% if message.tags == 'success' %}
                    showSuccess('OPERAÇÃO CONCLUÍDA', '{{ message|escapejs }}', 5000);
                {% elif message.tags == 'error' %}
                    showError('ERRO', '{{ message|escapejs }}', 6000);
                {% elif message.tags == 'warning' %}
                    showWarning('ATENÇÃO', '{{ message|escapejs }}', 6000);
                {% elif message.tags == 'info' %}
                    showInfo('INFORMAÇÃO', '{{ message|escapejs }}', 5000);
                {% else %}
                    showInfo('NOTIFICAÇÃO', '{{ message|escapejs }}', 5000);
                {% endif %}
            }, 300);
        {% endfor %}
    {% endif %}
});
</script>


<script>
// ============================================
// FUNÇÕES PARA CHAMADOS
// ============================================

let chamadoAtual = null;

// Carregar chamados quando a aba for aberta
function carregarChamados() {
    const clienteId = '{{ cliente.id }}';
    
    fetch(`/clientes/chamados/listar/?id=${clienteId}`)
        .then(response => response.json())
        .then(data => {
            renderizarChamados(data.chamados);
        })
        .catch(error => {
            console.error('Erro ao carregar chamados:', error);
            document.getElementById('listaChamados').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--error-red); opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Erro ao carregar chamados</p>
                </div>
            `;
        });
}

function renderizarChamados(chamados) {
    const container = document.getElementById('listaChamados');
    
    if (chamados.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-ticket-alt" style="font-size: 64px; color: var(--accent-cyan); opacity: 0.3;"></i>
                <p class="mt-3 text-muted">Nenhum chamado cadastrado</p>
                <button class="btn btn-primary mt-3" onclick="abrirModalCadastrarChamado()">
                    <i class="fas fa-plus me-2"></i> Criar Primeiro Chamado
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    chamados.forEach(chamado => {
        const prioridadeClass = chamado.prioridade.toLowerCase().replace(' ', '-');
        const statusClass = chamado.status.toLowerCase().replace(' ', '-');
        
        html += `
            <div class="chamado-card ${prioridadeClass}" onclick="abrirModalVisualizarChamado(${chamado.id})">
                <div class="chamado-header">
                    <div>
                        <div class="chamado-numero">#${chamado.id}</div>
                        <div class="chamado-titulo">${chamado.titulo}</div>
                    </div>
                    <div class="chamado-badges">
                        <span class="badge-custom badge-prioridade ${prioridadeClass}">${chamado.prioridade}</span>
                        <span class="badge-custom badge-status ${statusClass}">${chamado.status}</span>
                    </div>
                </div>
                
                <div class="chamado-info">
                    <div class="chamado-info-item">
                        <span class="chamado-info-label">Categoria</span>
                        <span class="chamado-info-value">${chamado.categoria || 'Não definida'}</span>
                    </div>
                    <div class="chamado-info-item">
                        <span class="chamado-info-label">Departamento</span>
                        <span class="chamado-info-value">${chamado.departamento}</span>
                    </div>
                    <div class="chamado-info-item">
                        <span class="chamado-info-label">Responsável</span>
                        <span class="chamado-info-value">${chamado.responsavel}</span>
                    </div>
                    <div class="chamado-info-item">
                        <span class="chamado-info-label">Data</span>
                        <span class="chamado-info-value">${chamado.data_criacao}</span>
                    </div>
                    <div class="chamado-info-item">
                        <span class="chamado-info-label">Comentários</span>
                        <span class="chamado-info-value">
                            <i class="fas fa-comments"></i> ${chamado.total_comentarios}
                        </span>
                    </div>
                </div>
                
                <div class="chamado-actions" onclick="event.stopPropagation()">
                    <button class="btn-action-chamado" onclick="abrirModalVisualizarChamado(${chamado.id})">
                        <i class="fas fa-eye me-1"></i> Visualizar
                    </button>
                    <form method="POST" action="/clientes/chamados/deletar/${chamado.id}/" style="display: inline;" 
                          onsubmit="return confirm('Tem certeza que deseja excluir o chamado #${chamado.id}?')">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                        <button type="submit" class="btn-action-chamado btn-delete-chamado">
                            <i class="fas fa-trash me-1"></i> Excluir
                        </button>
                    </form>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Modal Cadastrar Chamado
function abrirModalCadastrarChamado() {
    document.getElementById('modalCadastrarChamado').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function fecharModalCadastrarChamado() {
    document.getElementById('modalCadastrarChamado').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('formCadastrarChamado').reset();
    document.getElementById('categoria').value = '';
    document.getElementById('categoria_input').value = '';
    document.getElementById('responsavel').value = '';
    document.getElementById('responsavel_input').value = '';
}

// Modal Adicionar Categoria
function abrirModalAdicionarCategoria() {
    document.getElementById('modalAdicionarCategoria').style.display = 'flex';
}

function fecharModalAdicionarCategoria() {
    document.getElementById('modalAdicionarCategoria').style.display = 'none';
    document.getElementById('nova_categoria_nome').value = '';
    document.getElementById('nova_categoria_descricao').value = '';
}

function salvarNovaCategoria() {
    const nome = document.getElementById('nova_categoria_nome').value.trim();
    const descricao = document.getElementById('nova_categoria_descricao').value.trim();
    
    if (!nome) {
        showError('ERRO', 'Digite o nome da categoria', 3000);
        return;
    }
    
    fetch('/clientes/categorias/cadastrar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `nome=${encodeURIComponent(nome)}&descricao=${encodeURIComponent(descricao)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError('ERRO', data.error, 4000);
        } else {
            showSuccess('SUCESSO', data.message, 3000);
            fecharModalAdicionarCategoria();
            // Adicionar a categoria ao campo de seleção
            document.getElementById('categoria').value = data.id;
            document.getElementById('categoria_input').value = data.nome;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('ERRO', 'Erro ao cadastrar categoria', 3000);
    });
}

// Buscar Categorias
function buscarCategorias(query, prefix = '') {
    const inputId = prefix ? `${prefix}_categoria_input` : 'categoria_input';
    const dropdownId = prefix ? `${prefix}_categoria-dropdown` : 'categoria-dropdown';
    const hiddenId = prefix ? `${prefix}_categoria` : 'categoria';
    
    const dropdown = document.getElementById(dropdownId);
    
    if (query.length < 1) {
        dropdown.classList.remove('show');
        return;
    }
    
    fetch(`/clientes/categorias/buscar/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            let html = '';
            
            if (data.results.length === 0) {
                html = '<div class="no-results">Nenhuma categoria encontrada</div>';
            } else {
                data.results.forEach(cat => {
                    html += `
                        <div class="search-select-option visible" 
                             data-value="${cat.id}" 
                             data-text="${cat.nome}"
                             onclick="selecionarOpcao('${prefix ? prefix + '_' : ''}categoria', ${cat.id}, '${cat.nome}')">
                            ${cat.nome}
                        </div>
                    `;
                });
            }
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
        })
        .catch(error => console.error('Erro:', error));
}

// Buscar Usuários
function buscarUsuarios(query, prefix = '') {
    const dropdownId = prefix ? `${prefix}_responsavel-dropdown` : 'responsavel-dropdown';
    const dropdown = document.getElementById(dropdownId);
    
    if (query.length < 2) {
        dropdown.classList.remove('show');
        return;
    }
    
    fetch(`/clientes/usuarios/buscar/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            let html = '';
            
            if (data.results.length === 0) {
                html = '<div class="no-results">Nenhum usuário encontrado</div>';
            } else {
                data.results.forEach(user => {
                    html += `
                        <div class="search-select-option visible" 
                             data-value="${user.id}" 
                             data-text="${user.nome}"
                             onclick="selecionarOpcao('${prefix ? prefix + '_' : ''}responsavel', ${user.id}, '${user.nome}')">
                            <strong>${user.nome}</strong> <small style="color: var(--text-muted);">(@${user.username})</small>
                        </div>
                    `;
                });
            }
            
            dropdown.innerHTML = html;
            dropdown.classList.add('show');
        })
        .catch(error => console.error('Erro:', error));
}

function selecionarOpcao(campo, valor, texto) {
    document.getElementById(campo).value = valor;
    document.getElementById(campo + '_input').value = texto;
    document.getElementById(campo + '-dropdown').classList.remove('show');
}

// Modal Visualizar/Editar Chamado
function abrirModalVisualizarChamado(chamadoId) {
    fetch(`/clientes/chamados/buscar/${chamadoId}/`)
        .then(response => response.json())
        .then(data => {
            chamadoAtual = data;
            
            document.getElementById('view_chamado_id').value = data.id;
            document.getElementById('view_chamado_numero').textContent = data.id;
            document.getElementById('view_titulo').value = data.titulo;
            document.getElementById('view_descricao').value = data.descricao;
            document.getElementById('view_status').value = data.status;
            document.getElementById('view_prioridade').value = data.prioridade;
            document.getElementById('view_departamento').value = data.departamento;
            document.getElementById('view_cliente').textContent = data.cliente_nome;
            document.getElementById('view_data_criacao').textContent = data.data_criacao;
            
            document.getElementById('view_categoria').value = data.categoria_id || '';
            document.getElementById('view_categoria_input').value = data.categoria_nome || '';
            document.getElementById('view_responsavel').value = data.responsavel_id || '';
            document.getElementById('view_responsavel_input').value = data.responsavel_nome || '';
            
            // Renderizar comentários
            renderizarComentarios(data.comentarios);
            document.getElementById('badge_comentarios').textContent = data.comentarios.length;
            
            document.getElementById('modalVisualizarChamado').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('ERRO', 'Não foi possível carregar o chamado', 3000);
        });
}

function fecharModalVisualizarChamado() {
    document.getElementById('modalVisualizarChamado').style.display = 'none';
    document.body.style.overflow = 'auto';
    chamadoAtual = null;
}

function renderizarComentarios(comentarios) {
    const container = document.getElementById('lista-comentarios');
    
    if (comentarios.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments" style="font-size: 48px; color: var(--text-muted); opacity: 0.3;"></i>
                <p class="mt-3 text-muted" style="font-size: 13px;">Nenhum comentário ainda</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    comentarios.forEach(com => {
        html += `
            <div class="comentario-item ${com.is_internal ? 'interno' : ''}">
                <div class="comentario-header">
                    <span class="comentario-autor">
                        ${com.usuario}
                        ${com.is_internal ? '<span class="badge-interno">Interno</span>' : ''}
                    </span>
                    <span class="comentario-data">${com.data}</span>
                </div>
                <div class="comentario-texto">${com.comentario}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function salvarEdicaoChamado() {
    if (!chamadoAtual) return;
    
    const form = document.getElementById('formEditarChamado');
    const formData = new FormData(form);
    
    fetch(`/clientes/chamados/editar/${chamadoAtual.id}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('ERRO', 'Erro ao salvar alterações', 3000);
    });
}

function adicionarComentario() {
    if (!chamadoAtual) return;
    
    const comentario = document.getElementById('novo_comentario').value.trim();
    const isInternal = document.getElementById('comentario_interno').checked;
    
    if (!comentario) {
        showError('ERRO', 'Digite um comentário', 3000);
        return;
    }
    
    const formData = new FormData();
    formData.append('comentario', comentario);
    formData.append('is_internal', isInternal);
    
    fetch(`/clientes/chamados/${chamadoAtual.id}/comentario/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            showSuccess('SUCESSO', 'Comentário adicionado', 3000);
            document.getElementById('novo_comentario').value = '';
            document.getElementById('comentario_interno').checked = false;
            // Recarregar o chamado para atualizar os comentários
            abrirModalVisualizarChamado(chamadoAtual.id);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('ERRO', 'Erro ao adicionar comentário', 3000);
    });
}

function trocarAbaModal(event, aba) {
    event.preventDefault();
    
    // Esconder todas as abas
    document.getElementById('aba-detalhes').style.display = 'none';
    document.getElementById('aba-comentarios').style.display = 'none';
    
    // Remover classe active de todos os links
    event.target.closest('.nav-tabs').querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Mostrar aba selecionada
    document.getElementById('aba-' + aba).style.display = 'block';
    event.target.classList.add('active');
}

// Função auxiliar para pegar o CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Carregar chamados quando a aba for aberta
document.addEventListener('DOMContentLoaded', function() {
    // Observer para detectar quando a aba de chamados é aberta
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            const tabChamados = document.getElementById('tab-chamados');
            if (tabChamados && tabChamados.style.display === 'block') {
                carregarChamados();
            }
        });
    });
    
    const tabChamados = document.getElementById('tab-chamados');
    if (tabChamados) {
        observer.observe(tabChamados, {
            attributes: true,
            attributeFilter: ['style']
        });
    }
    
    // Fechar dropdowns ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-search-select')) {
            document.querySelectorAll('.search-select-dropdown').forEach(d => {
                d.classList.remove('show');
            });
        }
        
        // Fechar modais ao clicar no overlay
        const modalCadastrar = document.getElementById('modalCadastrarChamado');
        if (e.target === modalCadastrar) {
            fecharModalCadastrarChamado();
        }
        
        const modalCategoria = document.getElementById('modalAdicionarCategoria');
        if (e.target === modalCategoria) {
            fecharModalAdicionarCategoria();
        }
        
        const modalVisualizar = document.getElementById('modalVisualizarChamado');
        if (e.target === modalVisualizar) {
            fecharModalVisualizarChamado();
        }
    });
    
    // ESC fecha modais
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            fecharModalCadastrarChamado();
            fecharModalAdicionarCategoria();
            fecharModalVisualizarChamado();
        }
    });
});
</script>
{% endblock content %}